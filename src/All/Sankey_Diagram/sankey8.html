<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>英国能源流动系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }

      body {
        background-color: #ffffff;
        color: #333;
        min-height: 100vh;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow-x: hidden;
      }

      .container {
        max-width: 1400px;
        width: 100%;
        background: #f9f9f9;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: #eef4ff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      h1 {
        color: #1a202c;
        font-size: 42px;
        margin-bottom: 15px;
        font-weight: 800;
        letter-spacing: 1px;
      }

      .subtitle {
        color: #4a5568;
        font-size: 22px;
        margin-bottom: 25px;
        line-height: 1.6;
        font-weight: 300;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 16px 32px;
        background-color: #4299e1;
        color: #ffffff;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn:hover {
        background-color: #3182ce;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .btn:active {
        transform: translateY(1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .chart-container {
        width: 100%;
        height: 800px;
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      #sankey-chart {
        width: 100%;
        height: 100%;
      }

      .status-message {
        text-align: center;
        margin: 20px 0;
        font-size: 20px;
        color: #4299e1;
        min-height: 30px;
        font-weight: 600;
      }

      .legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        background: #eef4ff;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .legend-item:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 1px solid #cbd5e0;
      }

      .instructions {
        text-align: center;
        margin-top: 30px;
        color: #718096;
        font-size: 18px;
        font-style: italic;
      }

      @media (max-width: 900px) {
        .container {
          padding: 20px;
        }
        h1 {
          font-size: 32px;
        }
        .subtitle {
          font-size: 18px;
        }
        .btn {
          padding: 12px 24px;
          font-size: 14px;
        }
        .chart-container {
          height: 600px;
        }
      }

      @media (max-width: 600px) {
        h1 {
          font-size: 28px;
        }
        .subtitle {
          font-size: 16px;
        }
        .chart-container {
          height: 500px;
        }
        .legend {
          gap: 15px;
        }
        .legend-item {
          padding: 8px 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>英国能源流动系统</h1>
        <div class="subtitle">可视化展示能源从来源到最终消耗的完整路径和效率</div>
      </div>

      <div class="controls">
        <button id="load-data" class="btn">加载能源数据</button>
        <button id="reset-view" class="btn">重置视图</button>
        <button id="staging-animation" class="btn">分步动画</button>
      </div>

      <div class="status-message" id="status-message">准备加载能源数据</div>

      <div class="chart-container">
        <div id="sankey-chart"></div>
      </div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background-color: #4299e1"></div>
          <span>能源来源</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #48bb78"></div>
          <span>转换过程</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ed8936"></div>
          <span>能源消耗</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #f56565"></div>
          <span>能源损耗</span>
        </div>
      </div>

      <div class="instructions">提示：点击 "分步动画" 按钮，观察能源的逐级流动。</div>
    </div>

    <script>
      const chart = echarts.init(document.getElementById('sankey-chart'))
      const statusMessage = document.getElementById('status-message')

      const energyData = `source,target,value
农业废弃物,生物转化,124.729
生物转化,液体燃料,0.597
生物转化,能源损失,26.862
生物转化,固体燃料,280.322
生物转化,气体燃料,81.144
生物燃料进口,液体燃料,35.000
生物质进口,固体燃料,35.000
煤炭进口,煤炭,11.606
煤炭储量,煤炭,63.965
煤炭,固体燃料,75.571
区域供热,工业,10.639
区域供热,商业供暖与制冷,22.505
区域供热,住宅供暖与制冷,46.184
电网,过量发电/出口,104.453
电网,住宅供暖与制冷,113.726
电网,氢气转化,27.140
电网,工业,342.165
电网,公路运输,37.797
电网,农业,4.412
电网,商业供暖与制冷,40.858
电网,能源损失,56.691
电网,铁路运输,7.863
电网,商业照明与电器,90.008
电网,住宅照明与电器,93.494
天然气进口,天然气,40.719
天然气储量,天然气,82.233
天然气,商业供暖与制冷,0.129
天然气,能源损失,1.401
天然气,热能发电,151.891
天然气,农业,2.096
天然气,工业,48.580
地热能,电网,7.013
氢气转化,氢气,20.897
氢气转化,能源损失,6.242
氢气,公路运输,20.897
水力发电,电网,6.995
液体燃料,工业,121.066
液体燃料,国际航运,128.690
液体燃料,公路运输,135.835
液体燃料,国内航空,14.458
液体燃料,国际航空,206.267
液体燃料,农业,3.640
液体燃料,国内航运,33.218
液体燃料,铁路运输,4.413
海洋藻类,生物转化,4.375
核能,热能发电,839.978
石油进口,石油,504.287
石油储量,石油,107.703
石油,液体燃料,611.990
其他废弃物,固体燃料,56.587
其他废弃物,生物转化,77.810
抽水蓄热,住宅供暖与制冷,193.026
抽水蓄热,商业供暖与制冷,70.672
太阳能光伏,电网,59.901
太阳能热能,住宅供暖与制冷,19.263
太阳能,太阳能热能,19.263
太阳能,太阳能光伏,59.901
固体燃料,农业,0.882
固体燃料,热能发电,400.120
固体燃料,工业,46.477
热能发电,电网,525.531
热能发电,能源损失,787.129
热能发电,区域供热,79.329
潮汐能,电网,9.452
英国陆地生物能源,生物转化,182.010
波浪能,电网,19.013
风能,电网,289.366`

      let allNodes = []
      let allLinks = []
      let stagingAnimationIndex = 0
      let stagingGroups = []

      function processCSVData() {
        const rows = energyData
          .split('\n')
          .map((row) => row.trim())
          .filter((row) => row)
        const links = []
        const nodeMap = new Map()

        for (let i = 1; i < rows.length; i++) {
          const columns = []
          let current = ''
          let inQuotes = false

          for (let j = 0; j < rows[i].length; j++) {
            const char = rows[i][j]
            if (char === '"') {
              inQuotes = !inQuotes
            } else if (char === ',' && !inQuotes) {
              columns.push(current)
              current = ''
            } else {
              current += char
            }
          }
          columns.push(current)

          if (columns.length >= 3) {
            const source = columns[0].replace(/"/g, '')
            const target = columns[1].replace(/"/g, '')
            const value = parseFloat(columns[2])

            if (!isNaN(value)) {
              links.push({ source, target, value })
              if (!nodeMap.has(source)) nodeMap.set(source, { name: source })
              if (!nodeMap.has(target)) nodeMap.set(target, { name: target })
            }
          }
        }

        allNodes = Array.from(nodeMap.values())
        allLinks = links
        categorizeNodes(allNodes)

        // Define staging groups based on data flow
        const sourceNodes = allNodes.filter(
          (node) => !allLinks.some((link) => link.target === node.name),
        )
        const intermediateNodes = allNodes.filter(
          (node) =>
            sourceNodes.every((sn) => sn.name !== node.name) && !isFinalConsumption(node.name),
        )
        const finalNodes = allNodes.filter((node) => isFinalConsumption(node.name))

        // Re-define stages for animation based on user's request
        stagingGroups = [
          { name: '能源来源', nodes: sourceNodes, links: [] },
          {
            name: '中间转化',
            nodes: intermediateNodes,
            links: allLinks.filter(
              (link) =>
                sourceNodes.some((sn) => sn.name === link.source) &&
                intermediateNodes.some((tn) => tn.name === link.target),
            ),
          },
          {
            name: '终端消耗',
            nodes: finalNodes,
            links: allLinks.filter(
              (link) =>
                intermediateNodes.some((sn) => sn.name === link.source) &&
                finalNodes.some((tn) => tn.name === link.target),
            ),
          },
        ]
      }

      function isFinalConsumption(nodeName) {
        const consumptionKeywords = [
          '供暖',
          '制冷',
          '工业',
          '运输',
          '航空',
          '航运',
          '农业',
          '照明',
          '电器',
          '住宅',
          '商业',
          '公路',
          '铁路',
          '能源损失',
          '出口',
        ]
        return consumptionKeywords.some((keyword) => nodeName.includes(keyword))
      }

      function categorizeNodes(nodes) {
        const sourceKeywords = [
          '进口',
          '储量',
          '废弃物',
          '藻类',
          '生物能源',
          '地热能',
          '水力发电',
          '核能',
          '太阳能',
          '潮汐能',
          '波浪能',
          '风能',
        ]
        const processKeywords = [
          '转化',
          '发电',
          '电网',
          '天然气',
          '氢气',
          '石油',
          '煤炭',
          '固体燃料',
          '液体燃料',
          '气体燃料',
          '热能',
        ]
        const consumptionKeywords = [
          '供暖',
          '制冷',
          '工业',
          '运输',
          '航空',
          '航运',
          '农业',
          '照明',
          '电器',
          '住宅',
          '商业',
          '公路',
          '铁路',
        ]
        const lossKeywords = ['能源损失', '出口']

        nodes.forEach((node) => {
          const name = node.name
          if (lossKeywords.some((keyword) => name.includes(keyword))) {
            node.itemStyle = { color: '#f56565' }
          } else if (sourceKeywords.some((keyword) => name.includes(keyword))) {
            node.itemStyle = { color: '#4299e1' }
          } else if (processKeywords.some((keyword) => name.includes(keyword))) {
            node.itemStyle = { color: '#48bb78' }
          } else if (consumptionKeywords.some((keyword) => name.includes(keyword))) {
            node.itemStyle = { color: '#ed8936' }
          } else {
            node.itemStyle = { color: '#9f7aea' }
          }
        })
      }

      function generateSankeyChart(nodes, links) {
        const option = {
          title: {
            text: '英国能源流动系统',
            subtext: '数据来源: energy_zh.csv',
            textStyle: { color: '#1a202c', fontSize: 28, fontWeight: 'bold' },
            subtextStyle: { color: '#4a5568', fontSize: 18 },
            left: 'center',
            top: 10,
          },
          tooltip: {
            trigger: 'item',
            formatter: (params) => {
              if (params.dataType === 'node') {
                return `<div style="font-weight:bold;margin-bottom:5px;">${params.name}</div><div>能源类型: ${getNodeType(params.name)}</div>`
              } else {
                return `<div style="font-weight:bold;margin-bottom:5px;">${params.data.source} → ${params.data.target}</div><div>流量: ${params.data.value.toFixed(3)} TWh</div>`
              }
            },
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: '#e2e8f0',
            textStyle: { color: '#333' },
            padding: 10,
            extraCssText: 'box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border-radius: 8px;',
          },
          series: [
            {
              type: 'sankey',
              layout: 'none',
              data: nodes,
              links: links,
              emphasis: { focus: 'adjacency' },
              lineStyle: { color: 'gradient', curveness: 0.5 },
              itemStyle: { borderWidth: 1, borderColor: '#fff' },
              label: {
                color: '#333',
                fontWeight: 'bold',
                fontSize: 14,
                formatter: (params) =>
                  params.name.length > 12 ? params.name.substring(0, 12) + '...' : params.name,
              },
              nodeWidth: 20,
              nodeGap: 12,
              animationDuration: 1500,
              animationEasing: 'cubicOut',
            },
          ],
        }

        chart.hideLoading()
        chart.setOption(option, true)
      }

      function getNodeType(nodeName) {
        const lossKeywords = ['能源损失', '出口']
        const sourceKeywords = [
          '进口',
          '储量',
          '废弃物',
          '藻类',
          '生物能源',
          '地热能',
          '水力发电',
          '核能',
          '太阳能',
          '潮汐能',
          '波浪能',
          '风能',
        ]
        const processKeywords = [
          '转化',
          '发电',
          '电网',
          '天然气',
          '氢气',
          '石油',
          '煤炭',
          '固体燃料',
          '液体燃料',
          '气体燃料',
          '热能',
        ]
        const consumptionKeywords = [
          '供暖',
          '制冷',
          '工业',
          '运输',
          '航空',
          '航运',
          '农业',
          '照明',
          '电器',
          '住宅',
          '商业',
          '公路',
          '铁路',
        ]

        if (lossKeywords.some((keyword) => nodeName.includes(keyword))) return '能源损耗'
        if (sourceKeywords.some((keyword) => nodeName.includes(keyword))) return '能源来源'
        if (processKeywords.some((keyword) => nodeName.includes(keyword))) return '转换过程'
        if (consumptionKeywords.some((keyword) => nodeName.includes(keyword))) return '能源消耗'
        return '其他'
      }

      function startStagingAnimation() {
        processCSVData()
        stagingAnimationIndex = 0
        showNextStage()
      }

      function showNextStage() {
        if (stagingAnimationIndex >= stagingGroups.length) {
          statusMessage.textContent = '动画完成'
          return
        }

        const currentNodes = new Set()
        const currentLinks = []
        for (let i = 0; i <= stagingAnimationIndex; i++) {
          stagingGroups[i].nodes.forEach((node) => currentNodes.add(node))
          currentLinks.push(...stagingGroups[i].links)
        }

        generateSankeyChart(Array.from(currentNodes), currentLinks)
        statusMessage.textContent = `第 ${stagingAnimationIndex + 1} 阶段：正在展示能源流动 - ${stagingGroups[stagingAnimationIndex].name}...`
        stagingAnimationIndex++
        setTimeout(showNextStage, 3000)
      }

      document.getElementById('load-data').addEventListener('click', function () {
        statusMessage.textContent = '正在处理能源数据...'
        processCSVData()
        generateSankeyChart(allNodes, allLinks)
        statusMessage.textContent = '能源数据加载完成'
      })

      document.getElementById('reset-view').addEventListener('click', function () {
        chart.clear()
        chart.showLoading({
          text: '准备加载能源数据',
          color: '#4299e1',
          textColor: '#4a5568',
          maskColor: 'rgba(255, 255, 255, 0.8)',
        })
        statusMessage.textContent = '准备加载能源数据'
      })

      document.getElementById('staging-animation').addEventListener('click', startStagingAnimation)

      processCSVData()
      generateSankeyChart([], [])
    </script>
  </body>
</html>
