<!doctype html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>全球迁移流静态展示</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: transparent;
        overflow: hidden;
      }

      .container {
        max-width: 100%;
        height: auto;
        margin: 0px auto;
        background: transparent;
        padding: 0;
        border-radius: 0;
        box-shadow: none;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 16px;
      }

      .info-panel {
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #3498db;
      }

      .legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 10px;
        margin: 10px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        width: 70%;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 11px;
      }

      .legend-color {
        width: 15px;
        height: 3px;
        border-radius: 2px;
      }

      #chart-container {
        position: relative;
        width: 70%;
        flex: 1;
        margin: 0;
        border: none;
        overflow: hidden;
        background: transparent;
      }

      #loading {
        text-align: left;
        margin-top: 10px;
        font-size: 12px;
        color: #555;
      }

      svg {
        position: relative;
        z-index: 1;
        background: transparent;
      }

      .link {
        fill: none;
        stroke-opacity: 0.7;
      }

      .node {
        stroke: #fff;
        stroke-width: 2px;
      }

      .node-label {
        font-size: 9px;
        font-weight: 600;
        text-anchor: middle;
        pointer-events: none;
        fill: #333;
      }

      .route-path {
        fill: none;
        stroke-linecap: round;
        stroke-opacity: 0.8;
      }

      .world-map {
        fill: #e8e8e8;
        stroke: #d0d0d0;
        stroke-width: 0.5;
        opacity: 0.6;
      }

      .label-bg {
        fill: rgba(255, 255, 255, 0.9);
        stroke: #ddd;
        stroke-width: 1;
        rx: 4;
        ry: 4;
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="legend" id="legend"></div>

      <div id="chart-container">
        <div id="loading"><span>加载数据中...</span></div>
        <svg id="map" width="100%" height="350"></svg>
      </div>
    </div>

    <script>
      /* ---------- 全局变量与常量 ---------- */
      let dataLoaded = null
      let links = []
      let thicknessScale

      const regions = [
        'EUROPE',
        'NORTHERN AMERICA',
        'Central and Southern Asia',
        'Latin America and the Caribbean',
        'Oceania (excluding Australia and New Zealand)',
        'Sub-Saharan Africa',
        'Eastern and South-Eastern Asia',
      ]
      const regionNames = {
        EUROPE: '欧洲',
        'NORTHERN AMERICA': '北美洲',
        'Central and Southern Asia': '中南亚',
        'Latin America and the Caribbean': '拉丁美洲',
        'Oceania (excluding Australia and New Zealand)': '大洋洲',
        'Sub-Saharan Africa': '撒哈拉以南非洲',
        'Eastern and South-Eastern Asia': '东亚和东南亚',
      }

      const regionColors = {
        EUROPE: '#8dd3c7',
        'NORTHERN AMERICA': '#E2D874',
        'Central and Southern Asia': '#bebada',
        'Latin America and the Caribbean': '#fdb462',
        'Oceania (excluding Australia and New Zealand)': '#b3de69',
        'Sub-Saharan Africa': '#f49fc7',
        'Eastern and South-Eastern Asia': '#bc80bd',
      }

      // 动态获取SVG宽度并设置投影
      let svgWidth,
        svgHeight = 350
      let projection, pos

      function initializeProjection() {
        const svg = document.getElementById('map')
        svgWidth = svg.getBoundingClientRect().width

        projection = d3
          .geoMercator()
          .center([30, 15])
          .scale(svgWidth * 0.18)
          .translate([svgWidth / 2, svgHeight / 2])

        pos = {
          EUROPE: projection([15, 50]),
          'NORTHERN AMERICA': projection([-100, 45]),
          'Central and Southern Asia': projection([70, 30]),
          'Latin America and the Caribbean': projection([-70, -20]),
          'Oceania (excluding Australia and New Zealand)': projection([140, -20]),
          'Sub-Saharan Africa': projection([20, -10]),
          'Eastern and South-Eastern Asia': projection([110, 20]),
        }
      }

      /* ---------- 数据处理与初始化 ---------- */
      const svg = d3.select('#map')
      const mapGroup = svg.append('g').attr('id', 'map-group')
      const linkGroup = svg.append('g').attr('id', 'link-group')
      const nodeGroup = svg.append('g').attr('id', 'node-group')
      const labelGroup = svg.append('g').attr('id', 'label-group')
      const loadingDiv = document.getElementById('loading')

      function initialize() {
        initializeProjection()
        drawWorldMap()
        createLegend()
        d3.csv('imbig_data.csv')
          .then((data) => {
            loadingDiv.style.display = 'none'
            processData(data)
            drawAllRoutes()
          })
          .catch((error) => {
            console.error('Error loading data:', error)
            loadingDiv.textContent = '数据加载失败，请检查文件。'
            loadingDiv.style.color = 'red'
          })
      }

      function drawWorldMap() {
        const path = d3.geoPath().projection(projection)
        d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
          .then((worldData) => {
            mapGroup
              .selectAll('path')
              .data(topojson.feature(worldData, worldData.objects.countries).features)
              .enter()
              .append('path')
              .attr('d', path)
              .attr('class', 'world-map')
          })
          .catch((error) => {
            console.error('Error loading map data:', error)
          })
      }

      function createLegend() {
        const legendContainer = document.getElementById('legend')
        regions.forEach((region) => {
          const legendItem = document.createElement('div')
          legendItem.className = 'legend-item'

          const colorBox = document.createElement('div')
          colorBox.className = 'legend-color'
          colorBox.style.backgroundColor = regionColors[region]

          const label = document.createElement('span')
          label.textContent = regionNames[region]

          legendItem.appendChild(colorBox)
          legendItem.appendChild(label)
          legendContainer.appendChild(legendItem)
        })
      }

      function processData(data) {
        dataLoaded = data
        links = []
        data.forEach((row) => {
          const src = row['Origin Region']
          regions.forEach((tgt) => {
            const value = +row[tgt]
            if (value > 0 && src !== tgt) {
              links.push({
                source: src,
                target: tgt,
                value: value,
                color: regionColors[tgt],
              })
            }
          })
        })

        const maxValue = d3.max(links, (d) => d.value)
        thicknessScale = d3.scalePow().exponent(0.5).domain([0, maxValue]).range([0.5, 7.5])
      }

      function drawAllRoutes() {
        // 绘制节点和标签
        drawStaticElements()

        // 绘制所有路线
        links.forEach((link) => {
          const s = { x: pos[link.source][0], y: pos[link.source][1] }
          const t = { x: pos[link.target][0], y: pos[link.target][1] }
          const dx = t.x - s.x
          const dy = t.y - s.y
          const dr = Math.sqrt(dx * dx + dy * dy)

          const pathData = `M${s.x},${s.y}A${dr},${dr} 0 0,1 ${t.x},${t.y}`
          const strokeWidth = thicknessScale(link.value)

          // 主路线
          linkGroup
            .append('path')
            .attr('class', 'route-path')
            .attr('d', pathData)
            .attr('stroke', link.color)
            .attr('stroke-width', strokeWidth)
            .append('title')
            .text(
              `${regionNames[link.source]} → ${regionNames[link.target]}: ${link.value.toLocaleString()} 人`,
            )
        })
      }

      function drawStaticElements() {
        const nodes = regions.map((r) => ({ id: r, x: pos[r][0], y: pos[r][1] }))

        // 绘制节点
        nodeGroup
          .selectAll('.node')
          .data(nodes)
          .enter()
          .append('circle')
          .attr('class', 'node')
          .attr('r', 5)
          .attr('cx', (d) => d.x)
          .attr('cy', (d) => d.y)
          .attr('fill', (d) => regionColors[d.id])
          .attr('stroke', '#fff')
          .attr('stroke-width', 1.5)

        // 标签背景
        labelGroup
          .selectAll('.label-bg')
          .data(nodes)
          .enter()
          .append('rect')
          .attr('class', 'label-bg')
          .attr('x', (d) => d.x - 40)
          .attr('y', (d) => d.y - 22)
          .attr('width', 80)
          .attr('height', 16)

        // 标签文字
        labelGroup
          .selectAll('.node-label')
          .data(nodes)
          .enter()
          .append('text')
          .attr('class', 'node-label')
          .attr('x', (d) => d.x)
          .attr('y', (d) => d.y - 10)
          .text((d) => regionNames[d.id] || d.id)
      }

      // 窗口大小改变时重新初始化
      window.addEventListener('resize', function () {
        initializeProjection()
        mapGroup.selectAll('*').remove()
        linkGroup.selectAll('*').remove()
        nodeGroup.selectAll('*').remove()
        labelGroup.selectAll('*').remove()
        drawWorldMap()
        if (dataLoaded) {
          drawAllRoutes()
        }
      })

      initialize()
    </script>
  </body>
</html>
