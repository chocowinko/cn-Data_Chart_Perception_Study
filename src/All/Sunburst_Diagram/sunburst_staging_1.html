<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>咖啡风味轮旭日图 - 分阶段</title>
    <!-- Defines basic styles to make the chart fill the page -->
    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        background-color: transparent;
      }
      #main {
        width: 100vw;
        height: 100vh;
      }
      /* Step indicator overlay */
      #step-indicator {
        position: absolute;
        left: 16px; /* will be overridden by JS */
        top: 16px;  /* will be overridden by JS */
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.05);
        color: #2c3e50;
        font-family: PingFang SC, sans-serif;
        font-weight: 600;
        font-size: 16px;
        line-height: 24px;
        border-radius: 6px;
        pointer-events: none;
        transition: opacity 200ms ease;
        opacity: 0.9;
        transform: translateX(-50%);
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <!-- The container where the chart will be rendered -->
    <div id="main"></div>
    <div id="step-indicator">阶段 0：初始化（隐藏全部层级）</div>

    <!-- Import the ECharts library from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <!-- Your chart initialization script -->
    <script type="text/javascript">
      // 中文翻译映射
      const translations = {'Floral':'花香','Black Tea':'红茶','Chamomile':'洋甘菊','Rose':'玫瑰','Jasmine':'茉莉','Fruity':'果味','Berry':'浆果','Blackberry':'黑莓','Raspberry':'覆盆子','Blueberry':'蓝莓','Strawberry':'草莓','Dried Fruit':'干果','Raisin':'葡萄干','Prune':'西梅','Other Fruit':'其他水果','Coconut':'椰子','Cherry':'樱桃','Pomegranate':'石榴','Pineapple':'菠萝','Grape':'葡萄','Apple':'苹果','Peach':'桃子','Pear':'梨','Citrus Fruit':'柑橘类水果','Grapefruit':'葡萄柚','Orange':'橙子','Lemon':'柠檬','Lime':'青柠','Sour/\nFermented':'酸/发酵','Sour':'酸味','Sour Aromatics':'酸香','Acetic Acid':'醋酸','Butyric Acid':'丁酸','Isovaleric Acid':'异戊酸','Citric Acid':'柠檬酸','Malic Acid':'苹果酸','Alcohol/\nFermented':'酒精/发酵','Winey':'酒香','Whiskey':'威士忌','Fermented':'发酵','Overripe':'过熟','Green/\nVegetative':'绿色/植物味','Olive Oil':'橄榄油','Raw':'生的','Under-ripe':'未熟','Peapod':'豌豆荚','Fresh':'新鲜','Dark Green':'深绿','Vegetative':'植物味','Hay-like':'干草味','Herb-like':'草本味','Beany':'豆味','Other':'其他','Papery/Musty':'纸味/霉味','Stale':'陈腐','Cardboard':'纸板','Papery':'纸味','Woody':'木质','Moldy/Damp':'霉味/潮湿','Musty/Dusty':'霉味/灰尘','Musty/Earthy':'霉味/泥土','Animalic':'动物味','Meaty/Brothy':'肉味/汤味','Phenolic':'酚味','Chemical':'化学','Bitter':'苦味','Salty':'咸味','Medicinal':'药味','Petroleum':'石油','Skunky':'臭味','Rubber':'橡胶','Roasted':'烘焙味','Pipe Tobacco':'烟斗烟草','Tobacco':'烟草','Burnt':'焦味','Acrid':'辛辣','Ashy':'灰烬','Smoky':'烟熏','Brown Roast':'深度烘焙','Grain':'谷物','Malt':'麦芽','Spices':'香料味','Pungent':'刺激','Pepper':'胡椒','Brown Spice':'棕色香料','Anise':'八角','Nutmeg':'肉豆蔻','Cinnamon':'肉桂','Clove':'丁香','Nutty/\nCocoa':'坚果/可可','Nutty':'坚果味','Peanuts':'花生','Hazelnut':'榛子','Almond':'杏仁','Cocoa':'可可','Chocolate':'巧克力','Dark Chocolate':'黑巧克力','Sweet':'甜味','Brown Sugar':'红糖','Molasses':'糖蜜','Maple Syrup':'枫糖浆','Caramelized':'焦糖化','Honey':'蜂蜜','Vanilla':'香草','Vanillin':'香兰素','Overall Sweet':'整体甜','Sweet Aromatics':'甜香'};
      function translate(text){return translations[text]||text;}

      var chartDom = document.getElementById('main')
      var myChart = echarts.init(chartDom)
      var option

      var data = [
        {
          name: 'Floral',
          itemStyle: { color: '#da0d68' },
          children: [
            { name: 'Black Tea', value: 1, itemStyle: { color: '#975e6d' } },
            {
              name: 'Floral',
              itemStyle: { color: '#e0719c' },
              children: [
                { name: 'Chamomile', value: 1, itemStyle: { color: '#f99e1c' } },
                { name: 'Rose', value: 1, itemStyle: { color: '#ef5a78' } },
                { name: 'Jasmine', value: 1, itemStyle: { color: '#f7f1bd' } },
              ],
            },
          ],
        },
        {
          name: 'Fruity',
          itemStyle: { color: '#da1d23' },
          children: [
            {
              name: 'Berry',
              itemStyle: { color: '#dd4c51' },
              children: [
                { name: 'Blackberry', value: 1, itemStyle: { color: '#3e0317' } },
                { name: 'Raspberry', value: 1, itemStyle: { color: '#e62969' } },
                { name: 'Blueberry', value: 1, itemStyle: { color: '#6569b0' } },
                { name: 'Strawberry', value: 1, itemStyle: { color: '#ef2d36' } },
              ],
            },
            {
              name: 'Dried Fruit',
              itemStyle: { color: '#c94a44' },
              children: [
                { name: 'Raisin', value: 1, itemStyle: { color: '#b53b54' } },
                { name: 'Prune', value: 1, itemStyle: { color: '#a5446f' } },
              ],
            },
            {
              name: 'Other Fruit',
              itemStyle: { color: '#dd4c51' },
              children: [
                { name: 'Coconut', value: 1, itemStyle: { color: '#f2684b' } },
                { name: 'Cherry', value: 1, itemStyle: { color: '#e73451' } },
                { name: 'Pomegranate', value: 1, itemStyle: { color: '#e65656' } },
                { name: 'Pineapple', value: 1, itemStyle: { color: '#f89a1c' } },
                { name: 'Grape', value: 1, itemStyle: { color: '#aeb92c' } },
                { name: 'Apple', value: 1, itemStyle: { color: '#4eb849' } },
                { name: 'Peach', value: 1, itemStyle: { color: '#f68a5c' } },
                { name: 'Pear', value: 1, itemStyle: { color: '#baa635' } },
              ],
            },
            {
              name: 'Citrus Fruit',
              itemStyle: { color: '#f7a128' },
              children: [
                { name: 'Grapefruit', value: 1, itemStyle: { color: '#f26355' } },
                { name: 'Orange', value: 1, itemStyle: { color: '#e2631e' } },
                { name: 'Lemon', value: 1, itemStyle: { color: '#fde404' } },
                { name: 'Lime', value: 1, itemStyle: { color: '#7eb138' } },
              ],
            },
          ],
        },
        {
          name: 'Sour/\nFermented',
          itemStyle: { color: '#ebb40f' },
          children: [
            {
              name: 'Sour',
              itemStyle: { color: '#e1c315' },
              children: [
                { name: 'Sour Aromatics', value: 1, itemStyle: { color: '#9ea718' } },
                { name: 'Acetic Acid', value: 1, itemStyle: { color: '#94a76f' } },
                { name: 'Butyric Acid', value: 1, itemStyle: { color: '#d0b24f' } },
                { name: 'Isovaleric Acid', value: 1, itemStyle: { color: '#8eb646' } },
                { name: 'Citric Acid', value: 1, itemStyle: { color: '#faef07' } },
                { name: 'Malic Acid', value: 1, itemStyle: { color: '#c1ba07' } },
              ],
            },
            {
              name: 'Alcohol/\nFermented',
              itemStyle: { color: '#b09733' },
              children: [
                { name: 'Winey', value: 1, itemStyle: { color: '#8f1c53' } },
                { name: 'Whiskey', value: 1, itemStyle: { color: '#b34039' } },
                { name: 'Fermented', value: 1, itemStyle: { color: '#ba9232' } },
                { name: 'Overripe', value: 1, itemStyle: { color: '#8b6439' } },
              ],
            },
          ],
        },
        {
          name: 'Green/\nVegetative',
          itemStyle: { color: '#187a2f' },
          children: [
            { name: 'Olive Oil', value: 1, itemStyle: { color: '#a2b029' } },
            { name: 'Raw', value: 1, itemStyle: { color: '#718933' } },
            {
              name: 'Green/\nVegetative',
              itemStyle: { color: '#3aa255' },
              children: [
                { name: 'Under-ripe', value: 1, itemStyle: { color: '#a2bb2b' } },
                { name: 'Peapod', value: 1, itemStyle: { color: '#62aa3c' } },
                { name: 'Fresh', value: 1, itemStyle: { color: '#03a653' } },
                { name: 'Dark Green', value: 1, itemStyle: { color: '#038549' } },
                { name: 'Vegetative', value: 1, itemStyle: { color: '#28b44b' } },
                { name: 'Hay-like', value: 1, itemStyle: { color: '#a3a830' } },
                { name: 'Herb-like', value: 1, itemStyle: { color: '#7ac141' } },
              ],
            },
            { name: 'Beany', value: 1, itemStyle: { color: '#5e9a80' } },
          ],
        },
        {
          name: 'Other',
          itemStyle: { color: '#0aa3b5' },
          children: [
            {
              name: 'Papery/Musty',
              itemStyle: { color: '#9db2b7' },
              children: [
                { name: 'Stale', value: 1, itemStyle: { color: '#8b8c90' } },
                { name: 'Cardboard', value: 1, itemStyle: { color: '#beb276' } },
                { name: 'Papery', value: 1, itemStyle: { color: '#fefef4' } },
                { name: 'Woody', value: 1, itemStyle: { color: '#744e03' } },
                { name: 'Moldy/Damp', value: 1, itemStyle: { color: '#a3a36f' } },
                { name: 'Musty/Dusty', value: 1, itemStyle: { color: '#c9b583' } },
                { name: 'Musty/Earthy', value: 1, itemStyle: { color: '#978847' } },
                { name: 'Animalic', value: 1, itemStyle: { color: '#9d977f' } },
                { name: 'Meaty/Brothy', value: 1, itemStyle: { color: '#cc7b6a' } },
                { name: 'Phenolic', value: 1, itemStyle: { color: '#db646a' } },
              ],
            },
            {
              name: 'Chemical',
              itemStyle: { color: '#76c0cb' },
              children: [
                { name: 'Bitter', value: 1, itemStyle: { color: '#80a89d' } },
                { name: 'Salty', value: 1, itemStyle: { color: '#def2fd' } },
                { name: 'Medicinal', value: 1, itemStyle: { color: '#7a9bae' } },
                { name: 'Petroleum', value: 1, itemStyle: { color: '#039fb8' } },
                { name: 'Skunky', value: 1, itemStyle: { color: '#5e777b' } },
                { name: 'Rubber', value: 1, itemStyle: { color: '#120c0c' } },
              ],
            },
          ],
        },
        {
          name: 'Roasted',
          itemStyle: { color: '#c94930' },
          children: [
            { name: 'Pipe Tobacco', value: 1, itemStyle: { color: '#caa465' } },
            { name: 'Tobacco', value: 1, itemStyle: { color: '#dfbd7e' } },
            {
              name: 'Burnt',
              itemStyle: { color: '#be8663' },
              children: [
                { name: 'Acrid', value: 1, itemStyle: { color: '#b9a449' } },
                { name: 'Ashy', value: 1, itemStyle: { color: '#899893' } },
                { name: 'Smoky', value: 1, itemStyle: { color: '#a1743b' } },
                { name: 'Brown Roast', value: 1, itemStyle: { color: '#894810' } },
              ],
            },
            {
              name: 'Grain',
              itemStyle: { color: '#ddaf61' },
              children: [
                { name: 'Grain', value: 1, itemStyle: { color: '#b7906f' } },
                { name: 'Malt', value: 1, itemStyle: { color: '#eb9d5f' } },
              ],
            },
          ],
        },
        {
          name: 'Spices',
          itemStyle: { color: '#ad213e' },
          children: [
            { name: 'Pungent', value: 1, itemStyle: { color: '#794752' } },
            { name: 'Pepper', value: 1, itemStyle: { color: '#cc3d41' } },
            {
              name: 'Brown Spice',
              itemStyle: { color: '#b14d57' },
              children: [
                { name: 'Anise', value: 1, itemStyle: { color: '#c78936' } },
                { name: 'Nutmeg', value: 1, itemStyle: { color: '#8c292c' } },
                { name: 'Cinnamon', value: 1, itemStyle: { color: '#e5762e' } },
                { name: 'Clove', value: 1, itemStyle: { color: '#a16c5a' } },
              ],
            },
          ],
        },
        {
          name: 'Nutty/\nCocoa',
          itemStyle: { color: '#a87b64' },
          children: [
            {
              name: 'Nutty',
              itemStyle: { color: '#c78869' },
              children: [
                { name: 'Peanuts', value: 1, itemStyle: { color: '#d4ad12' } },
                { name: 'Hazelnut', value: 1, itemStyle: { color: '#9d5433' } },
                { name: 'Almond', value: 1, itemStyle: { color: '#c89f83' } },
              ],
            },
            {
              name: 'Cocoa',
              itemStyle: { color: '#bb764c' },
              children: [
                { name: 'Chocolate', value: 1, itemStyle: { color: '#692a19' } },
                { name: 'Dark Chocolate', value: 1, itemStyle: { color: '#470604' } },
              ],
            },
          ],
        },
        {
          name: 'Sweet',
          itemStyle: { color: '#e65832' },
          children: [
            {
              name: 'Brown Sugar',
              itemStyle: { color: '#d45a59' },
              children: [
                { name: 'Molasses', value: 1, itemStyle: { color: '#310d0f' } },
                { name: 'Maple Syrup', value: 1, itemStyle: { color: '#ae341f' } },
                { name: 'Caramelized', value: 1, itemStyle: { color: '#d78823' } },
                { name: 'Honey', value: 1, itemStyle: { color: '#da5c1f' } },
              ],
            },
            { name: 'Vanilla', value: 1, itemStyle: { color: '#f89a80' } },
            { name: 'Vanillin', value: 1, itemStyle: { color: '#f37674' } },
            { name: 'Overall Sweet', value: 1, itemStyle: { color: '#e75b68' } },
            { name: 'Sweet Aromatics', value: 1, itemStyle: { color: '#d0545f' } },
          ],
        },
      ]

      option = {
        series: {
          type: 'sunburst',
          data: data,
          radius: [0, '95%'],
          sort: undefined,
          silent: true,
          emphasis: {
            focus: 'ancestor',
          },
          levels: [
            {
              silent: true,
            },
            {
              r0: '15%',
              r: '35%',
              itemStyle: {
                borderWidth: 2,
                opacity: 0,
              },
              label: {
                rotate: 'tangential',
                show: false,
              },
              silent: true,
            },
            {
              r0: '35%',
              r: '70%',
              itemStyle: {
                opacity: 0,
              },
              label: {
                align: 'right',
                show: false,
              },
              silent: true,
            },
            {
              r0: '70%',
              r: '72%',
              itemStyle: {
                borderWidth: 3,
                opacity: 0,
              },
              label: {
                position: 'outside',
                padding: 3,
                show: false,
                silent: true,
              },
              silent: true,
            },
          ],
        },
      }

      myChart.setOption(option)
      // Position the step indicator once at startup (keep hidden until animation starts)
      positionStepIndicator()

      // Staging animation - layer by layer display
      let currentStage = 0
      let animationTimers = []

      function positionStepIndicator() {
        var el = document.getElementById('step-indicator')
        if (!el) return
        // Center horizontally, above the sunburst outer ring vertically
        var vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0)
        var vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)
        var minDim = Math.min(vw, vh)
        var centerX = Math.round(vw / 2)
        var centerY = Math.round(vh / 2)
        var radius = (minDim * 0.95) / 2 // matches chart radius
        var top = Math.round(centerY - radius - 40) // 40px above the outer ring
        el.style.left = centerX + 'px'
        el.style.top = Math.max(10, top) + 'px'
      }

      function setStep(text) {
        var el = document.getElementById('step-indicator')
        if (el) {
          el.textContent = text
          el.style.opacity = 0.95
          el.style.visibility = 'visible'
          positionStepIndicator()
        }
      }

      function playStagingAnimation() {
        // Clear previous timers
        animationTimers.forEach((timer) => clearTimeout(timer))
        animationTimers = []

        currentStage = 0

        // Reset to initial state immediately (all layers hidden)
        myChart.setOption({
          series: {
            levels: [
              { silent: true },
              {
                r0: '15%',
                r: '35%',
                itemStyle: { borderWidth: 2, opacity: 0 },
                label: { rotate: 'tangential', show: false, formatter: function(params) { return translate(params.name); } },
                silent: true,
              },
              {
                r0: '35%',
                r: '70%',
                itemStyle: { opacity: 0 },
                label: { show: false, formatter: function(params) { return translate(params.name); } },
                silent: true,
              },
              {
                r0: '70%',
                r: '72%',
                itemStyle: { opacity: 0 },
                label: { show: false, formatter: function(params) { return translate(params.name); } },
                silent: true,
              },
            ],
          },
        })

        // Step text: initial
        setStep('阶段 0：初始化（隐藏全部层级）')

        // Stage 1 (~300ms later): Show only top-level categories
        animationTimers.push(
          setTimeout(() => {
            currentStage = 1
            setStep('阶段 1：显示第一层（大类）')
            myChart.setOption({
              series: {
                levels: [
                  { silent: true },
                  {
                    r0: '15%',
                    r: '35%',
                    itemStyle: { borderWidth: 2, opacity: 1 },
                    label: { rotate: 'tangential', show: true, formatter: function(params) { return translate(params.name); } },
                    silent: true,
                  },
                  {
                    r0: '35%',
                    r: '70%',
                    itemStyle: { opacity: 0 },
                    label: { show: false, formatter: function(params) { return translate(params.name); } },
                    silent: true,
                  },
                  {
                    r0: '70%',
                    r: '72%',
                    itemStyle: { opacity: 0 },
                    label: { show: false, formatter: function(params) { return translate(params.name); } },
                    silent: true,
                  },
                ],
              },
            })
          }, 300),
        )

        // Stage 2 (~2550ms later): Show second layer
        animationTimers.push(
          setTimeout(() => {
            currentStage = 2
            setStep('阶段 2：显示第二层（子类别）')
            myChart.setOption({
              series: {
                levels: [
                  { silent: true },
                  {
                    r0: '15%',
                    r: '35%',
                    itemStyle: { borderWidth: 2, opacity: 1 },
                    label: { rotate: 'tangential', show: true, formatter: function(params) { return translate(params.name); } },
                    silent: true,
                  },
                  {
                    r0: '35%',
                    r: '70%',
                    itemStyle: { opacity: 1 },
                    label: { align: 'right', show: true, formatter: function(params) { return translate(params.name); } },
                    silent: true,
                  },
                  {
                    r0: '70%',
                    r: '72%',
                    itemStyle: { opacity: 0 },
                    label: { show: false, formatter: function(params) { return translate(params.name); } },
                    silent: true,
                  },
                ],
              },
            })
          }, 2550),
        )

        // Stage 3 (~4800ms later): Show all layers
        animationTimers.push(
          setTimeout(() => {
            currentStage = 3
            setStep('阶段 3：显示全部层级（含最外层标签）')
            myChart.setOption({
              series: {
                levels: [
                  { silent: true },
                  {
                    r0: '15%',
                    r: '35%',
                    itemStyle: { borderWidth: 2, opacity: 1 },
                    label: { rotate: 'tangential', show: true, formatter: function(params) { return translate(params.name); } },
                    silent: true,
                  },
                  {
                    r0: '35%',
                    r: '70%',
                    itemStyle: { opacity: 1 },
                    label: { align: 'right', show: true, formatter: function(params) { return translate(params.name); } },
                    silent: true,
                  },
                  {
                    r0: '70%',
                    r: '72%',
                    itemStyle: { borderWidth: 3, opacity: 1 },
                    label: { position: 'outside', padding: 3, show: true, formatter: function(params) { return translate(params.name); } },
                    silent: true,
                  },
                ],
              },
            })
          }, 4800),
        )

        // Final message (~7050ms later): Animation complete
        animationTimers.push(
          setTimeout(() => {
            setStep('动画完成')
          }, 7050),
        )
      }

      // Expose for external call
      window.playStagingAnimation = playStagingAnimation

      // Add a listener to resize the chart when the window is resized
      window.addEventListener('resize', function () {
        myChart.resize()
        positionStepIndicator()
      })
    </script>
  </body>
</html>
