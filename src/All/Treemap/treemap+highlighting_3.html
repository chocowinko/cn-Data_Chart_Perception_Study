<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Superstore 2016 vs 2017 Treemap 对比图 (带高亮)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 10px;
        background-color: transparent;
        text-align: center;
      }
      h1 {
        display: none;
      }
      #main-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 10px;
        max-width: 100%;
        width: 100%;
        margin: 15px 0 0 0;
      }
      .chart-container {
        border: 1px solid #ccc;
        background: #fff;
        padding: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .tooltip {
        position: absolute;
        text-align: center;
        padding: 8px 12px;
        font-size: 12px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .tooltip-format {
        font-weight: bold;
      }
      .node-label {
        fill: white;
        font-size: 8px;
        pointer-events: none;
      }
      .parent-label {
        fill: white;
        font-size: 12px;
        font-weight: bold;
        pointer-events: none;
      }

      @keyframes flashBorder {
        0%,
        100% {
          stroke: #30ebe8;
          stroke-width: 2px;
        }
        50% {
          stroke: #30ebe8;
          stroke-width: 6px;
          filter: drop-shadow(0 0 6px #30ebe8);
        }
      }

      .highlight-animation {
        animation: flashBorder 1.5s infinite;
        z-index: 9999;
        position: relative;
      }

      .sub-category-group {
        transition: opacity 0.5s;
      }
    </style>
  </head>
  <body>
    <h1>Superstore Sales Treemap</h1>
    <div id="main-container">
      <div>
        <h3>2016 Sales Data</h3>
        <div class="chart-container">
          <div id="chart-1"></div>
        </div>
      </div>
      <div>
        <h3>2017 Sales Data</h3>
        <div class="chart-container">
          <div id="chart-2"></div>
        </div>
      </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      const chartWidth = 700
      const chartHeight = 900

      // 增长最快的前五名子品类数据
      const top5Growth2016 = ['Supplies', 'Machines', 'Copiers', 'Fasteners', 'Tables']
      const top5Growth2017 = ['Appliances', 'Art', 'Binders', 'Accessories', 'Labels']

      // 创建一个通用的Tooltip
      const tooltip = d3.select('body').append('div').attr('class', 'tooltip')

      // 自定义颜色映射 - 产品类别
      const colorMap = {
        Technology: {
          base: '#66c2a5',
          level1: '#8dd3c7',
          level2: '#b3e5d1',
        },
        Furniture: {
          base: '#fc8d62',
          level1: '#fda085',
          level2: '#feb3a8',
        },
        'Office Supplies': {
          base: '#8da0cb',
          level1: '#a6b3d4',
          level2: '#bfc6dd',
        },
      }

      const getColor = (category, depth) => {
        const colors = colorMap[category]
        if (!colors) return '#cccccc'

        switch (depth) {
          case 1:
            return colors.base // Category - 基础色
          case 2:
            return colors.level1 // Sub-Category - 中等深度
          case 3:
            return colors.level2 // Segment - 最深色
          default:
            return colors.base
        }
      }

      // --- 核心绘图函数 ---
      function createTreemap(containerId, dataForYear, year) {
        const svg = d3
          .select(containerId)
          .append('svg')
          .attr('width', chartWidth)
          .attr('height', chartHeight)

        // 按产品类别分组数据
        const hierarchyData = { name: 'root', children: [] }
        const groupedByCategory = d3.group(dataForYear, (d) => d.category)

        groupedByCategory.forEach((categoryData, category) => {
          const categoryNode = { name: category, children: [] }

          // 按子类别分组
          const groupedBySubCategory = d3.group(categoryData, (d) => d.subCategory)

          groupedBySubCategory.forEach((subCategoryData, subCategory) => {
            const subCategoryNode = { name: subCategory, children: [] }

            // 按客户类型聚合销售额
            const segmentSales = d3.rollup(
              subCategoryData,
              (v) => d3.sum(v, (d) => d.sales),
              (d) => d.segment,
            )

            segmentSales.forEach((sales, segment) => {
              subCategoryNode.children.push({
                name: segment,
                value: sales,
                segment: segment,
                category: category,
                subCategory: subCategory,
              })
            })

            categoryNode.children.push(subCategoryNode)
          })

          hierarchyData.children.push(categoryNode)
        })

        const root = d3
          .hierarchy(hierarchyData)
          .sum((d) => d.value)
          .sort((a, b) => b.value - a.value)

        d3.treemap().size([chartWidth, chartHeight]).padding(1).paddingTop(20)(root)

        const cell = svg
          .selectAll('g')
          .data(root.descendants())
          .enter()
          .append('g')
          .attr('class', (d) => (d.depth === 2 ? 'sub-category-group' : 'category-group'))
          .attr('data-sub-category', (d) => (d.depth === 2 ? d.data.name : null))
          .attr('data-year', year)
          .attr('transform', (d) => `translate(${d.x0},${d.y0})`)

        cell
          .append('rect')
          .attr('width', (d) => d.x1 - d.x0)
          .attr('height', (d) => d.y1 - d.y0)
          .attr('fill', (d) => {
            if (!d.depth) return 'transparent'
            // 根据产品类别着色
            const category =
              d.depth === 1
                ? d.data.name
                : d.depth === 2
                  ? d.parent.data.name
                  : d.parent.parent.data.name
            return getColor(category, d.depth)
          })
          .attr('stroke', '#fff')
          .attr('stroke-width', 1)

        // 产品类别标签 (depth 1)
        cell
          .filter((d) => d.depth === 1)
          .append('text')
          .attr('class', 'parent-label')
          .attr('x', 4)
          .attr('y', 13)
          .text((d) => d.data.name)

        // 子类别标签 (depth 2)
        cell
          .filter((d) => d.depth === 2)
          .append('text')
          .attr('class', 'node-label')
          .attr('x', 4)
          .attr('y', 13)
          .text((d) => d.data.name)
          .style('display', (d) => (d.x1 - d.x0 < 10 ? 'none' : 'inline'))

        const leafCells = cell.filter((d) => !d.children)

        // 第一行：客户类型名称
        leafCells
          .append('text')
          .attr('class', 'node-label')
          .attr('x', 4)
          .attr('y', 13)
          .text((d) =>
            d.data.name.length > 10 ? d.data.name.substring(0, 10) + '...' : d.data.name,
          )
          .style('display', (d) => (d.x1 - d.x0 < 30 ? 'none' : 'inline'))

        // 第二行：销售额
        leafCells
          .append('text')
          .attr('class', 'node-label')
          .attr('x', 4)
          .attr('y', 25)
          .text((d) => `$${d3.format(',.0f')(d.data.value)}`)
          .style('display', (d) => (d.x1 - d.x0 < 30 || d.y1 - d.y0 < 30 ? 'none' : 'inline'))

        leafCells
          .on('mouseover', function (event, d) {
            tooltip.style('opacity', 0.9)
            tooltip
              .html(
                `<div class="tooltip-format">${d.data.category}</div>` +
                  `<div>子类别: ${d.data.subCategory}</div>` +
                  `<div>客户类型: ${d.data.segment}</div>` +
                  `<div>销售额: $${d3.format(',.2f')(d.data.value)}</div>`,
              )
              .style('left', event.pageX + 10 + 'px')
              .style('top', event.pageY - 28 + 'px')
          })
          .on('mouseout', function (d) {
            tooltip.style('opacity', 0)
          })

        // 创建高亮边框层
        const highlightLayer = svg
          .append('g')
          .attr('class', 'highlight-layer')
          .style('pointer-events', 'none')
          .style('opacity', 0)

        // 在高亮层绘制边框
        const highlightData = root.descendants().filter((d) => {
          if (d.depth === 2) {
            // 高亮所有属于"Furniture"类别的子品类
            const category = d.parent.data.name
            return category === 'Furniture'
          }
          return false
        })

        highlightLayer
          .selectAll('rect')
          .data(highlightData)
          .enter()
          .append('rect')
          .attr('x', (d) => d.x0)
          .attr('y', (d) => d.y0)
          .attr('width', (d) => d.x1 - d.x0)
          .attr('height', (d) => d.y1 - d.y0)
          .attr('fill', 'none')
          .attr('class', 'highlight-animation')
      }

      // --- 主逻辑：加载数据并为每个年份调用绘图函数 ---
      d3.csv('superstore_temporal_data.csv')
        .then(function (data) {
          // 清洗和预处理数据 - 聚合月度数据为年度数据
          const aggregatedData = []

          // 按年份、类别、子类别聚合数据
          const groupedData = d3.rollup(
            data,
            (v) => d3.sum(v, (d) => +d.value),
            (d) => +d.Year,
            (d) => d.level1,
            (d) => d.level2,
          )

          // 转换为所需格式
          groupedData.forEach((categories, year) => {
            if (year === 2016 || year === 2017) {
              categories.forEach((subcategories, category) => {
                subcategories.forEach((sales, subCategory) => {
                  // 为每个子类别创建三个客户段的数据
                  ;['Consumer', 'Corporate', 'Home Office'].forEach((segment) => {
                    aggregatedData.push({
                      year: year,
                      sales: sales / 3, // 平均分配到三个客户段
                      segment: segment,
                      category: category,
                      subCategory: subCategory,
                    })
                  })
                })
              })
            }
          })

          // 分别处理两个年份的数据并绘图
          const years = [
            { id: '#chart-1', year: 2016 },
            { id: '#chart-2', year: 2017 },
          ]

          years.forEach((y) => {
            const yearData = aggregatedData.filter((d) => d.year === y.year)
            createTreemap(y.id, yearData, y.year)
          })
        })
        .catch(function (error) {
          console.error('数据加载失败:', error)
          document.querySelector('#main-container').innerHTML =
            `<p style="color: red; text-align: center;">错误：无法加载数据文件 'superstore_temporal_data.csv'。请确保文件存在。</p>`
        })

      window.playHighlightAnimation = function () {
        // 显示所有高亮层
        d3.selectAll('.highlight-layer').transition().duration(500).style('opacity', 1)
      }
    </script>
  </body>
</html>
