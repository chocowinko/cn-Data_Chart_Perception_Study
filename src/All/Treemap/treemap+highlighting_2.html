<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Superstore 2016 vs 2017 Treemap 对比图 (带高亮)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 10px;
        background-color: transparent;
        text-align: center;
      }
      h1 {
        display: none;
      }
      #main-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 10px;
        max-width: 100%;
        width: 100%;
        margin: 15px 0 0 0;
      }
      .chart-container {
        border: 1px solid #ccc;
        background: #fff;
        padding: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .tooltip {
        position: absolute;
        text-align: center;
        padding: 8px 12px;
        font-size: 12px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .tooltip-format {
        font-weight: bold;
      }
      .node-label {
        fill: white;
        pointer-events: none;
      }
      .sub-category-label {
        font-size: 14px;
        font-weight: 600;
      }
      .segment-label {
        font-size: 12px;
      }
      .segment-value-label {
        font-size: 12px;
        font-weight: 500;
      }
      .parent-label {
        fill: white;
        font-size: 18px;
        font-weight: bold;
        pointer-events: none;
      }

      .sub-category-group {
        transition: opacity 0.5s;
      }
      .dimmed {
        fill: #dcdcdc !important;
        opacity: 0.35;
      }
    </style>
  </head>
  <body>
    <h1>超市销售树状图</h1>
    <div id="main-container">
      <div>
        <h3>2016年销售数据</h3>
        <div class="chart-container">
          <div id="chart-1"></div>
        </div>
      </div>
      <div>
        <h3>2017年销售数据</h3>
        <div class="chart-container">
          <div id="chart-2"></div>
        </div>
      </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      const chartWidth = 700
      const chartHeight = 900

      // 增长最快的前五名子品类数据
      const top5Growth2016 = ['Binders']
      const top5Growth2017 = ['Binders']

      // 创建一个通用的Tooltip
      const tooltip = d3.select('body').append('div').attr('class', 'tooltip')

      // 中文翻译映射
      const translations = {
        'Technology': '科技产品',
        'Furniture': '家具',
        'Office Supplies': '办公用品',
        'Consumer': '消费者',
        'Corporate': '企业',
        'Home Office': '家庭办公',
        'Phones': '手机',
        'Chairs': '椅子',
        'Storage': '储物柜',
        'Tables': '桌子',
        'Binders': '装订用品',
        'Machines': '机器',
        'Accessories': '配件',
        'Copiers': '复印机',
        'Bookcases': '书柜',
        'Appliances': '电器',
        'Furnishings': '家居用品',
        'Paper': '纸张',
        'Supplies': '办公耗材',
        'Art': '艺术用品',
        'Labels': '标签',
        'Envelopes': '信封',
        'Fasteners': '紧固件'
      }

      const translate = (text) => {
        return translations[text] || text
      }

      // 自定义颜色映射 - 产品类别
      const colorMap = {
        Technology: {
          base: '#66c2a5',
          level1: '#8dd3c7',
          level2: '#b3e5d1',
        },
        Furniture: {
          base: '#fc8d62',
          level1: '#fda085',
          level2: '#feb3a8',
        },
        'Office Supplies': {
          base: '#8da0cb',
          level1: '#a6b3d4',
          level2: '#bfc6dd',
        },
      }

      const getColor = (category, depth) => {
        const colors = colorMap[category]
        if (!colors) return '#cccccc'

        switch (depth) {
          case 1:
            return colors.base // Category - 基础色
          case 2:
            return colors.level1 // Sub-Category - 中等深度
          case 3:
            return colors.level2 // Segment - 最深色
          default:
            return colors.base
        }
      }

      // --- 核心绘图函数 ---
      function createTreemap(containerId, dataForYear, year) {
        const highlightSet = new Set(year === 2016 ? top5Growth2016 : top5Growth2017)

        const isHighlightedNode = (node) => {
          if (node.depth === 2) {
            return highlightSet.has(node.data.name)
          }
          if (node.depth > 2 && node.parent) {
            return highlightSet.has(node.parent.data.name)
          }
          return false
        }

        const getFillForNode = (node) => {
          if (!node.depth) return 'transparent'
          const category =
            node.depth === 1
              ? node.data.name
              : node.depth === 2
                ? node.parent.data.name
                : node.parent.parent.data.name
          return getColor(category, node.depth)
        }

        const svg = d3
          .select(containerId)
          .append('svg')
          .attr('width', chartWidth)
          .attr('height', chartHeight)

        // 按产品类别分组数据
        const hierarchyData = { name: 'root', children: [] }
        const groupedByCategory = d3.group(dataForYear, (d) => d.category)

        groupedByCategory.forEach((categoryData, category) => {
          const categoryNode = { name: category, children: [] }

          // 按子类别分组
          const groupedBySubCategory = d3.group(categoryData, (d) => d.subCategory)

          groupedBySubCategory.forEach((subCategoryData, subCategory) => {
            const subCategoryNode = { name: subCategory, children: [] }

            // 按客户类型聚合销售额
            const segmentSales = d3.rollup(
              subCategoryData,
              (v) => d3.sum(v, (d) => d.sales),
              (d) => d.segment,
            )

            segmentSales.forEach((sales, segment) => {
              subCategoryNode.children.push({
                name: segment,
                value: sales,
                segment: segment,
                category: category,
                subCategory: subCategory,
              })
            })

            categoryNode.children.push(subCategoryNode)
          })

          hierarchyData.children.push(categoryNode)
        })

        const root = d3
          .hierarchy(hierarchyData)
          .sum((d) => d.value)
          .sort((a, b) => b.value - a.value)

        d3.treemap().size([chartWidth, chartHeight]).padding(1).paddingTop(30)(root)

        const cell = svg
          .selectAll('g')
          .data(root.descendants())
          .enter()
          .append('g')
          .attr('class', (d) => (d.depth === 2 ? 'sub-category-group' : 'category-group'))
          .attr('data-sub-category', (d) => (d.depth === 2 ? d.data.name : null))
          .attr('data-year', year)
          .attr('transform', (d) => `translate(${d.x0},${d.y0})`)

        cell
          .append('rect')
          .attr('width', (d) => d.x1 - d.x0)
          .attr('height', (d) => d.y1 - d.y0)
          .attr('fill', (d) => getFillForNode(d))
          .attr('stroke', '#fff')
          .attr('stroke-width', 1)
          .attr('data-original-fill', (d) => getFillForNode(d))
          .attr('data-highlighted', (d) => (isHighlightedNode(d) ? 'true' : 'false'))

        // 产品类别标签 (depth 1)
        cell
          .filter((d) => d.depth === 1)
          .append('text')
          .attr('class', 'parent-label')
          .attr('x', 4)
          .attr('y', 20)
          .text((d) => translate(d.data.name))

        // 子类别标签 (depth 2)
        cell
          .filter((d) => d.depth === 2)
          .append('text')
          .attr('class', 'node-label sub-category-label')
          .attr('x', 6)
          .attr('y', 22)
          .text((d) => translate(d.data.name))
          .style('display', (d) => (d.x1 - d.x0 < 10 ? 'none' : 'inline'))

        const leafCells = cell.filter((d) => !d.children)

        // 第一行：客户类型名称
        leafCells
          .append('text')
          .attr('class', 'node-label segment-label')
          .attr('x', 4)
          .attr('y', 13)
          .text((d) => {
            const translatedName = translate(d.data.name)
            return translatedName.length > 10 ? translatedName.substring(0, 10) + '...' : translatedName
          })
          .style('display', (d) => (d.x1 - d.x0 < 30 ? 'none' : 'inline'))

        // 第二行：销售额
        leafCells
          .append('text')
          .attr('class', 'node-label segment-value-label')
          .attr('x', 4)
          .attr('y', 25)
          .text((d) => `$${d3.format(',.0f')(d.data.value)}`)
          .style('display', (d) => (d.x1 - d.x0 < 30 || d.y1 - d.y0 < 30 ? 'none' : 'inline'))

        leafCells
          .on('mouseover', function (event, d) {
            tooltip.style('opacity', 0.9)
            tooltip
              .html(
                `<div class="tooltip-format">${translate(d.data.category)}</div>` +
                  `<div>子类别: ${translate(d.data.subCategory)}</div>` +
                  `<div>客户类型: ${translate(d.data.segment)}</div>` +
                  `<div>销售额: $${d3.format(',.2f')(d.data.value)}</div>`,
              )
              .style('left', event.pageX + 10 + 'px')
              .style('top', event.pageY - 28 + 'px')
          })
          .on('mouseout', function (d) {
            tooltip.style('opacity', 0)
          })

      }

      // --- 主逻辑：加载数据并为每个年份调用绘图函数 ---
      d3.csv('Sample - Superstore.csv')
        .then(function (data) {
          // 清洗和预处理数据
          const cleanData = data
            .map((d) => ({
              year: new Date(d['Order Date']).getFullYear(),
              sales: +d.Sales,
              segment: d.Segment,
              category: d.Category,
              subCategory: d['Sub-Category'],
            }))
            // 过滤掉不完整的数据，只保留2016和2017年
            .filter(
              (d) =>
                d.year &&
                d.sales &&
                d.segment &&
                d.category &&
                d.subCategory &&
                (d.year === 2016 || d.year === 2017),
            )

          // 按年份、类别、子类别、客户段聚合数据
          const aggregatedData = []
          const groupedData = d3.rollup(
            cleanData,
            (v) => d3.sum(v, (d) => d.sales),
            (d) => d.year,
            (d) => d.category,
            (d) => d.subCategory,
            (d) => d.segment,
          )

          // 转换为所需格式
          groupedData.forEach((categories, year) => {
            categories.forEach((subcategories, category) => {
              subcategories.forEach((segments, subCategory) => {
                segments.forEach((sales, segment) => {
                  aggregatedData.push({
                    year: year,
                    sales: sales,
                    segment: segment,
                    category: category,
                    subCategory: subCategory,
                  })
                })
              })
            })
          })

          // 分别处理两个年份的数据并绘图
          const years = [
            { id: '#chart-1', year: 2016 },
            { id: '#chart-2', year: 2017 },
          ]

          years.forEach((y) => {
            const yearData = aggregatedData.filter((d) => d.year === y.year)
            createTreemap(y.id, yearData, y.year)
          })
        })
        .catch(function (error) {
          console.error('数据加载失败:', error)
          document.querySelector('#main-container').innerHTML =
            `<p style="color: red; text-align: center;">错误：无法加载数据文件 'Sample - Superstore.csv'。请确保文件存在。</p>`
        })

      // 暴露函数给外部调用 - 播放高亮动画
      window.playHighlightAnimation = function () {
        const allRects = d3.selectAll('rect[data-original-fill]')
        allRects
          .transition()
          .duration(300)
          .attr('fill', function () {
            return d3.select(this).attr('data-original-fill')
          })
          .style('opacity', 1)

        const nonHighlightRects = allRects.filter(function () {
          return d3.select(this).attr('data-highlighted') === 'false'
        })

        nonHighlightRects
          .transition()
          .delay(300)
          .duration(400)
          .attr('fill', '#dcdcdc')
          .style('opacity', 0.35)

        allRects
          .filter(function () {
            return d3.select(this).attr('data-highlighted') === 'true'
          })
          .transition()
          .delay(300)
          .duration(400)
          .style('opacity', 1)
      }
    </script>
  </body>
</html>
