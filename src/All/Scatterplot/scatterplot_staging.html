<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>2016 Daily Average PM2.5 and Ozone Concentration Scatterplot</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: white;
        height: 100vh;
        overflow: hidden;
      }
      .container {
        max-width: none;
        margin: 0;
        background-color: white;
        padding: 5px;
        border-radius: 0;
        box-shadow: none;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .header {
        text-align: center;
        margin-bottom: 5px;
        flex-shrink: 0;
      }
      .header h1 {
        font-size: 18px;
        margin: 30px 0;
      }
      .stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
      }
      .stat-item {
        text-align: center;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
      }
      .stat-label {
        font-size: 14px;
        color: #666;
      }
      #plotDiv {
        width: 100%;
        flex: 1;
        min-height: 0;
      }
      .loading {
        text-align: center;
        padding: 50px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <b
            >2016 Daily Average PM2.5 and Ozone Concentration Scatterplot in Changping District,
            Beijing</b
          >
        </h1>
      </div>

      <div id="plotDiv"></div>
    </div>

    <script>
      // Parse CSV data
      function parseCSV(text) {
        const lines = text.trim().split('\n')
        const headers = lines[0].split(',').map((h) => h.replace(/"/g, ''))
        const data = []

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',')
          const row = {}
          headers.forEach((header, index) => {
            let value = values[index]
            if (value !== undefined) {
              // Remove quotes and convert to appropriate type
              value = value.replace(/"/g, '')
              row[header] = value
            }
          })
          data.push(row)
        }

        return data
      }

      // Process data for 2016 daily averages
      function processData(rawData) {
        // Filter for 2016 data and group by date
        const dailyData = {}

        rawData.forEach((row) => {
          const year = parseInt(row.year)
          if (year === 2016) {
            const month = row.month.toString().padStart(2, '0')
            const day = row.day.toString().padStart(2, '0')
            const date = `${year}-${month}-${day}`

            if (!dailyData[date]) {
              dailyData[date] = {
                pm25_sum: 0,
                o3_sum: 0,
                count: 0,
                year: year,
                month: parseInt(row.month),
                day: parseInt(row.day),
              }
            }

            const pm25 = parseFloat(row['PM2.5'])
            const o3 = parseFloat(row['O3'])

            if (!isNaN(pm25) && !isNaN(o3) && pm25 > 0 && o3 > 0) {
              dailyData[date].pm25_sum += pm25
              dailyData[date].o3_sum += o3
              dailyData[date].count++
            }
          }
        })

        // Calculate averages and prepare final data (only even days)
        const processedData = []
        Object.keys(dailyData).forEach((date) => {
          const day = dailyData[date]
          if (day.count > 0) {
            const dateObj = new Date(day.year, day.month - 1, day.day)
            const dayOfYear = Math.floor(
              (dateObj - new Date(day.year, 0, 0)) / (1000 * 60 * 60 * 24),
            )

            // Only include even-numbered days
            if (dayOfYear % 2 === 0) {
              processedData.push({
                date: date,
                pm25: day.pm25_sum / day.count,
                o3: day.o3_sum / day.count,
                dayOfYear: dayOfYear,
                monthName: dateObj.toLocaleDateString('en-US', { month: 'long' }),
              })
            }
          }
        })

        return processedData.sort((a, b) => new Date(a.date) - new Date(b.date))
      }

      // Calculate correlation coefficient
      function calculateCorrelation(x, y) {
        const n = x.length
        const sumX = x.reduce((a, b) => a + b, 0)
        const sumY = y.reduce((a, b) => a + b, 0)
        const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0)
        const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0)
        const sumYY = y.reduce((sum, yi) => sum + yi * yi, 0)

        const correlation =
          (n * sumXY - sumX * sumY) /
          Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY))

        return correlation
      }

      // Create the plot with step-by-step animation
      function createPlot(dailyData) {
        // Extract arrays for plotting
        const o3Values = dailyData.map((d) => d.o3)
        const pm25Values = dailyData.map((d) => d.pm25)
        const monthValues = dailyData.map((d) => new Date(d.date).getMonth() + 1)

        // Define month colors
        const monthColors = [
          '#E0C4C4',
          '#4FAFAF',
          '#A8C8A8',
          '#F0906F',
          '#9BC49C',
          '#448CB3',
          '#898888',
          '#E63946',
          '#F4E4BC',
          '#7FB3D3',
          '#D4AF37',
          '#BEA4B4',
        ]

        // Month names
        const monthNames = [
          'Jan',
          'Feb',
          'Mar',
          'Apr',
          'May',
          'Jun',
          'Jul',
          'Aug',
          'Sep',
          'Oct',
          'Nov',
          'Dec',
        ]

        // Prepare data by month
        const monthlyData = {}
        for (let month = 1; month <= 12; month++) {
          const monthIndices = monthValues
            .map((m, i) => (m === month ? i : -1))
            .filter((i) => i !== -1)
          if (monthIndices.length > 0) {
            monthlyData[month] = {
              x: monthIndices.map((i) => o3Values[i]),
              y: monthIndices.map((i) => pm25Values[i]),
              color: monthColors[month - 1],
              name: monthNames[month - 1],
            }
          }
        }

        // Calculate axis ranges based on all data
        const allX = Object.values(monthlyData).flatMap((month) => month.x)
        const allY = Object.values(monthlyData).flatMap((month) => month.y)
        const xMin = Math.min(...allX)
        const xMax = Math.max(...allX)
        const yMin = Math.min(...allY)
        const yMax = Math.max(...allY)

        // Add padding to ranges
        const xPadding = (xMax - xMin) * 0.05
        const yPadding = (yMax - yMin) * 0.05
        const xRange = [xMin - xPadding, xMax + xPadding]
        const yRange = [yMin - yPadding, yMax + yPadding]

        // Layout
        const layout = {
          xaxis: {
            title: 'Daily Average Ozone Concentration (μg/m³)',
            title_font: { size: 14 },
            showgrid: true,
            gridwidth: 1,
            gridcolor: 'rgba(128,128,128,0.2)',
            range: xRange,
          },
          yaxis: {
            title: 'Daily Average PM2.5 Concentration (μg/m³)',
            title_font: { size: 14 },
            showgrid: true,
            gridwidth: 1,
            gridcolor: 'rgba(128,128,128,0.2)',
            range: yRange,
          },
          plot_bgcolor: 'white',
          paper_bgcolor: 'white',
          font: { family: 'Arial, sans-serif' },
          hovermode: false,
          showlegend: true,
          legend: {
            orientation: 'v',
            x: 1.02,
            y: 1,
            bgcolor: 'rgba(255,255,255,0.8)',
            bordercolor: 'rgba(0,0,0,0.2)',
            borderwidth: 1,
          },
          margin: {
            t: 30,
            b: 100,
            l: 100,
            r: 120,
          },
        }

        // Configuration
        const config = {
          displayModeBar: false,
          staticPlot: true,
        }

        // Start with empty plot
        Plotly.newPlot('plotDiv', [], layout, config)

        // Animate month by month
        let currentMonth = 1
        const animateNextMonth = () => {
          if (currentMonth <= 12 && monthlyData[currentMonth]) {
            // Add current month's data
            const trace = {
              x: monthlyData[currentMonth].x,
              y: monthlyData[currentMonth].y,
              mode: 'markers',
              type: 'scatter',
              name: monthlyData[currentMonth].name,
              marker: {
                size: 8,
                color: monthlyData[currentMonth].color,
                opacity: 1.0,
              },
              hoverinfo: 'none',
            }

            Plotly.addTraces('plotDiv', trace)
          }

          currentMonth++

          // Continue animation if more months exist
          if (currentMonth <= 12) {
            setTimeout(animateNextMonth, 1000) // 1 second delay
          }
        }

        // Start animation after a short delay
        setTimeout(animateNextMonth, 500)
      }

      // Load and process data
      async function loadData() {
        try {
          const response = await fetch('PRSA_Data_Changping_20130301-20170228.csv')
          const csvText = await response.text()
          const rawData = parseCSV(csvText)
          const dailyData = processData(rawData)
          createPlot(dailyData)
        } catch (error) {
          console.error('Error loading data:', error)
          document.getElementById('plotDiv').innerHTML =
            '<div class="loading">Failed to load data</div>'
        }
      }

      // Initialize when page loads
      document.addEventListener('DOMContentLoaded', loadData)
    </script>
  </body>
</html>
